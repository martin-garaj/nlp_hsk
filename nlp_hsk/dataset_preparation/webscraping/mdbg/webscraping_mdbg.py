# -*- coding: utf-8 -*-
"""
This script loads a list of chinese characters, sends a URL request to 
https://mdbg.net, reads the response and parses the response to get pinyin 
and common phrases including the wb-scrapped symbol..

HOW TO parse data from HTML was motivated by the following StackOverFlow 
question:
https://stackoverflow.com/questions/30002313/selenium-finding-elements-by-class-name-in-python
"""

#%% Imports
from selenium import webdriver
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.common.by import By
import time
import pandas as pd
from pathlib import Path
import numpy as np
import pickle
import json
from collections import defaultdict 

#%% Inputs
# in case something goes wrong, the script can continue from any index
start_from_symbol_index = 0
# get the patter of URL
url_pattern = ["https://www.mdbg.net/chinese/chindict_ac_wdqb.php?st=0&l=15&i="]
# file containing a list of unique symbols symbols
file_list_chinese_chars = 'list_of_HSK_symbols.pickle'
# path to processed data (contains file_HSK_symbols)
path_to_processed_data = '../../HSK/processed_data'
# output file containing a dictionary of symbol:list(radicals) pairs
file_pinyin_phrase = 'dict_symbols2mdbg_pinyin_and_phrase'
# path to output data
path_to_output_data = 'raw_files/'

#%% Load list of symbols
# these symbols will be scrapped from internet one by one for pinyin 
# and phrases
list_chinese_chars = \
    pd.read_pickle(Path(path_to_processed_data, file_list_chinese_chars))

# debug - uncomment to webscrape several characters only
# list_chinese_chars = list_chinese_chars[153:154]

#%% Web-scapping
# print to console
print('Web scrapper for "'+ url_pattern[0] + '" will attempt to obtain ' \
      'pinyin for '+ str(len(list_chinese_chars)-start_from_symbol_index) \
      +' chinese symbols loaded from ' \
      +str(Path(path_to_processed_data, file_list_chinese_chars))+' file.')
if(start_from_symbol_index > 0):
    print('The web scrapper starts at ' \
          +str(start_from_symbol_index) +'th symbol.')


# allocate dictionary storing the scrapped radicals
dict_mdbg = defaultdict(dict)

# initialization
from selenium.webdriver.firefox.options import Options as FirefoxOptions
options = FirefoxOptions()
# this is importatnt to get clean JSON instead of JSON view website, which 
# is interactive website generated by Firefox
options.set_preference('devtools.jsonview.enabled', False)
options.add_argument('--headless')
driver = webdriver.Firefox(options=options)

# fetch radicals for every chinese character
for idx_symbol, symbol in enumerate(list_chinese_chars):
    
    # skip symbols which are presumably already loaded
    if(start_from_symbol_index > idx_symbol):
        continue
    
    # for URL
    # url = "https://www.mdbg.net/chinese/chindict_ac_wdqb.php?st=0&l=15&i="+symbol
    url = url_pattern[0]+symbol
    
    # repeat the process until the website answers
    request_ongoing = True
    first_exeption = True
    while(request_ongoing):
        try:
            # send URL request
            driver.get(url)
            # wait from 2 seconds
            time.sleep(2)
            
            content = driver.page_source
            content = driver.find_element(By.TAG_NAME, "pre").text
            
            # list caontaining entries retrieved from the dictionary, 
            # which finds the given symbol and words containing the symbol
            list_of_dicts = json.loads(content)
            # data has been successfullt scrapped
            request_ongoing = False
        except Exception as e:
            # print error value
            print(e)
            print('Waiting for 20 seconds, then I will try again ...')
            # wait a while and try again
            time.sleep(20)
            
    # store the data
    dict_mdbg[symbol] = list_of_dicts
    # save on every iteration in case of crash
    with open(Path(path_to_output_data, file_pinyin_phrase+'.pickle'), 'wb') \
        as handle:
            pickle.dump(dict_mdbg, 
                        handle, 
                        protocol=pickle.HIGHEST_PROTOCOL)

    print('('+str(idx_symbol+1)+'/'+str(len(list_chinese_chars)) \
          +') scrapped '+symbol+': '+str(list_of_dicts[0]['pinyin']) )

driver.quit()
    
